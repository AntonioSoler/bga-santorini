import{AnimationClip,Bone,Box3,BufferAttribute,BufferGeometry,ClampToEdgeWrapping,Color,DirectionalLight,DoubleSide,FileLoader,FrontSide,Group,InterleavedBuffer,InterleavedBufferAttribute,Interpolant,InterpolateDiscrete,InterpolateLinear,Line,LineBasicMaterial,LineLoop,LineSegments,LinearFilter,LinearMipmapLinearFilter,LinearMipmapNearestFilter,Loader,LoaderUtils,Material,MathUtils,Matrix4,Mesh,MeshBasicMaterial,MeshPhysicalMaterial,MeshStandardMaterial,MirroredRepeatWrapping,NearestFilter,NearestMipmapLinearFilter,NearestMipmapNearestFilter,NumberKeyframeTrack,Object3D,OrthographicCamera,PerspectiveCamera,PointLight,Points,PointsMaterial,PropertyBinding,QuaternionKeyframeTrack,RGBAFormat,RGBFormat,RepeatWrapping,Skeleton,SkinnedMesh,Sphere,SpotLight,TangentSpaceNormalMap,TextureLoader,TriangleFanDrawMode,TriangleStripDrawMode,Vector2,Vector3,VectorKeyframeTrack,sRGBEncoding}from"./three.js";var GLTFLoader=function(){function e(e){Loader.call(this,e),this.dracoLoader=null,this.ddsLoader=null}function a(){var e={};return{get:function(a){return e[a]},add:function(a,t){e[a]=t},remove:function(a){delete e[a]},removeAll:function(){e={}}}}function t(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=A.MSFT_TEXTURE_DDS,this.ddsLoader=e}function s(e){this.name=A.KHR_LIGHTS_PUNCTUAL;var a=e.extensions&&e.extensions[A.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=a.lights||[]}function r(){this.name=A.KHR_MATERIALS_UNLIT}function n(){this.name=A.KHR_MATERIALS_CLEARCOAT}function o(e){this.name=A.KHR_BINARY_GLTF,this.content=null,this.body=null;var a=new DataView(e,0,12);if(this.header={magic:LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:a.getUint32(4,!0),length:a.getUint32(8,!0)},"glTF"!==this.header.magic)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");else if(2>this.header.version)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var t,s=new DataView(e,12),r=0;r<s.byteLength;){t=s.getUint32(r,!0),r+=4;var n=s.getUint32(r,!0);if(r+=4,n===N.JSON){var o=new Uint8Array(e,12+r,t);this.content=LoaderUtils.decodeText(o)}else if(n===N.BIN){var i=12+r;this.body=e.slice(i,i+t)}r+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function l(e,a){if(!a)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=A.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=a,this.dracoLoader.preload()}function p(){this.name=A.KHR_TEXTURE_TRANSFORM}function c(e){MeshStandardMaterial.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var a={specular:{value:new Color().setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(e){for(var t in a)e.uniforms[t]=a[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;"),e.fragmentShader=e.fragmentShader.replace("uniform float metalness;","uniform float glossiness;"),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_pars_fragment>","#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif"),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_pars_fragment>","#ifdef USE_GLOSSINESSMAP\n\tuniform sampler2D glossinessMap;\n#endif"),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_fragment>","vec3 specularFactor = specular;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\ttexelSpecular = sRGBToLinear( texelSpecular );\n\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture\n\tspecularFactor *= texelSpecular.rgb;\n#endif"),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_fragment>","float glossinessFactor = glossiness;\n#ifdef USE_GLOSSINESSMAP\n\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );\n\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture\n\tglossinessFactor *= texelGlossiness.a;\n#endif"),e.fragmentShader=e.fragmentShader.replace("#include <lights_physical_fragment>","PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nvec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 );// 0.0525 corresponds to the base mip of a 256 cubemap.\nmaterial.specularRoughness += geometryRoughness;\nmaterial.specularRoughness = min( material.specularRoughness, 1.0 );\nmaterial.specularColor = specularFactor.rgb;")},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(e){a.specular.value=e}},specularMap:{get:function(){return a.specularMap.value},set:function(e){a.specularMap.value=e}},glossiness:{get:function(){return a.glossiness.value},set:function(e){a.glossiness.value=e}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(e){a.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_ROUGHNESSMAP=""):(delete this.defines.USE_ROUGHNESSMAP,delete this.defines.USE_GLOSSINESSMAP)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function u(){return{name:A.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return c},extendParams:function(e,a,t){var s=a.extensions[this.name];e.color=new Color(1,1,1),e.opacity=1;var r=[];if(Array.isArray(s.diffuseFactor)){var n=s.diffuseFactor;e.color.fromArray(n),e.opacity=n[3]}if(void 0!==s.diffuseTexture&&r.push(t.assignTexture(e,"map",s.diffuseTexture)),e.emissive=new Color(0,0,0),e.glossiness=void 0===s.glossinessFactor?1:s.glossinessFactor,e.specular=new Color(1,1,1),Array.isArray(s.specularFactor)&&e.specular.fromArray(s.specularFactor),void 0!==s.specularGlossinessTexture){var o=s.specularGlossinessTexture;r.push(t.assignTexture(e,"glossinessMap",o)),r.push(t.assignTexture(e,"specularMap",o))}return Promise.all(r)},createMaterial:function(e){var a=new c(e);return a.fog=!0,a.color=e.color,a.map=void 0===e.map?null:e.map,a.lightMap=null,a.lightMapIntensity=1,a.aoMap=void 0===e.aoMap?null:e.aoMap,a.aoMapIntensity=1,a.emissive=e.emissive,a.emissiveIntensity=1,a.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,a.bumpMap=void 0===e.bumpMap?null:e.bumpMap,a.bumpScale=1,a.normalMap=void 0===e.normalMap?null:e.normalMap,a.normalMapType=TangentSpaceNormalMap,e.normalScale&&(a.normalScale=e.normalScale),a.displacementMap=null,a.displacementScale=1,a.displacementBias=0,a.specularMap=void 0===e.specularMap?null:e.specularMap,a.specular=e.specular,a.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,a.glossiness=e.glossiness,a.alphaMap=null,a.envMap=void 0===e.envMap?null:e.envMap,a.envMapIntensity=1,a.refractionRatio=.98,a}}}function d(){this.name=A.KHR_MESH_QUANTIZATION}function m(e,a,t,s){Interpolant.call(this,e,a,t,s)}function g(e,a){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(a)&&/^\//.test(e)&&(a=a.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)?e:/^data:.*,.*$/i.test(e)?e:/^blob:.*$/i.test(e)?e:a+e)}function h(e){return void 0===e.DefaultMaterial&&(e.DefaultMaterial=new MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:FrontSide})),e.DefaultMaterial}function T(e,a,t){for(var s in t.extensions)void 0===e[s]&&(a.userData.gltfExtensions=a.userData.gltfExtensions||{},a.userData.gltfExtensions[s]=t.extensions[s])}function f(e,a){void 0!==a.extras&&("object"==typeof a.extras?Object.assign(e.userData,a.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+a.extras))}function S(e,a,t){for(var s,r=!1,n=!1,o=0,l=a.length;o<l&&(s=a[o],void 0!==s.POSITION&&(r=!0),void 0!==s.NORMAL&&(n=!0),!(r&&n));o++);if(!r&&!n)return Promise.resolve(e);for(var s,p=[],c=[],o=0,l=a.length;o<l;o++){if(s=a[o],r){var u=void 0===s.POSITION?e.attributes.position:t.getDependency("accessor",s.POSITION);p.push(u)}if(n){var u=void 0===s.NORMAL?e.attributes.normal:t.getDependency("accessor",s.NORMAL);c.push(u)}}return Promise.all([Promise.all(p),Promise.all(c)]).then(function(a){var t=a[0],s=a[1];return r&&(e.morphAttributes.position=t),n&&(e.morphAttributes.normal=s),e.morphTargetsRelative=!0,e})}function R(e,a){if(e.updateMorphTargets(),void 0!==a.weights)for(var t=0,s=a.weights.length;t<s;t++)e.morphTargetInfluences[t]=a.weights[t];if(a.extras&&Array.isArray(a.extras.targetNames)){var r=a.extras.targetNames;if(e.morphTargetInfluences.length===r.length){e.morphTargetDictionary={};for(var t=0,s=r.length;t<s;t++)e.morphTargetDictionary[r[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function x(e){var a,t=e.extensions&&e.extensions[A.KHR_DRACO_MESH_COMPRESSION];return a=t?"draco:"+t.bufferView+":"+t.indices+":"+y(t.attributes):e.indices+":"+y(e.attributes)+":"+e.mode,a}function y(e){for(var a="",t=Object.keys(e).sort(),s=0,r=t.length;s<r;s++)a+=t[s]+":"+e[t[s]]+";";return a}function M(e,t,s){this.json=e||{},this.extensions=t||{},this.options=s||{},this.cache=new a,this.primitiveCache={},this.textureLoader=new TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function _(e,a,t){var s=a.attributes,r=new Box3;if(void 0!==s.POSITION){var n=t.json.accessors[s.POSITION],o=n.min,l=n.max;if(void 0!==o&&void 0!==l)r.set(new Vector3(o[0],o[1],o[2]),new Vector3(l[0],l[1],l[2]));else return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}else return;var p=a.targets;if(void 0!==p){for(var c,u=new Vector3,d=new Vector3,m=0,g=p.length;m<g;m++)if(c=p[m],void 0!==c.POSITION){var n=t.json.accessors[c.POSITION],o=n.min,l=n.max;void 0!==o&&void 0!==l?(d.setX(Math.max(Math.abs(o[0]),Math.abs(l[0]))),d.setY(Math.max(Math.abs(o[1]),Math.abs(l[1]))),d.setZ(Math.max(Math.abs(o[2]),Math.abs(l[2]))),u.max(d)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}r.expandByVector(u)}e.boundingBox=r;var h=new Sphere;r.getCenter(h.center),h.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=h}function E(e,a,t){function s(a,s){return t.getDependency("accessor",a).then(function(a){e.setAttribute(s,a)})}var r=a.attributes,n=[];for(var o in r){var i=H[o]||o.toLowerCase();i in e.attributes||n.push(s(r[o],i))}if(void 0!==a.indices&&!e.index){var l=t.getDependency("accessor",a.indices).then(function(a){e.setIndex(a)});n.push(l)}return f(e,a),_(e,a,t),Promise.all(n).then(function(){return void 0===a.targets?e:S(e,a.targets,t)})}function L(e,a){var t=e.getIndex();if(null===t){var s=[],r=e.getAttribute("position");if(void 0!==r){for(var n=0;n<r.count;n++)s.push(n);e.setIndex(s),t=e.getIndex()}else return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e}var o=t.count-2,l=[];if(a===TriangleFanDrawMode)for(var n=1;n<=o;n++)l.push(t.getX(0)),l.push(t.getX(n)),l.push(t.getX(n+1));else for(var n=0;n<o;n++)0==n%2?(l.push(t.getX(n)),l.push(t.getX(n+1)),l.push(t.getX(n+2))):(l.push(t.getX(n+2)),l.push(t.getX(n+1)),l.push(t.getX(n)));l.length/3!=o&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var p=e.clone();return p.setIndex(l),p}e.prototype=Object.assign(Object.create(Loader.prototype),{constructor:e,load:function(a,t){var s=this;return new Promise(function(e,r){var n;n=""===s.resourcePath?""===s.path?LoaderUtils.extractUrlBase(a):s.path:s.resourcePath,s.manager.itemStart(a);var o=function(t){r?r(t):console.error(t),s.manager.itemError(a),s.manager.itemEnd(a)},i=new FileLoader(s.manager);i.setPath(s.path),i.setResponseType("arraybuffer"),"use-credentials"===s.crossOrigin&&i.setWithCredentials(!0),i.load(a,function(t){try{s.parse(t,n,function(t){e(t),s.manager.itemEnd(a)},o)}catch(a){o(a)}},t,o)})},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(e){return this.ddsLoader=e,this},parse:function(e,a,c,m){var g,h={};if("string"==typeof e)g=e;else{var T=LoaderUtils.decodeText(new Uint8Array(e,0,4));if(T===I){try{h[A.KHR_BINARY_GLTF]=new o(e)}catch(e){return void(m&&m(e))}g=h[A.KHR_BINARY_GLTF].content}else g=LoaderUtils.decodeText(new Uint8Array(e))}var f=JSON.parse(g);if(void 0===f.asset||2>f.asset.version[0])return void(m&&m(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));if(f.extensionsUsed)for(var S=0;S<f.extensionsUsed.length;++S){var R=f.extensionsUsed[S],x=f.extensionsRequired||[];R===A.KHR_LIGHTS_PUNCTUAL?h[R]=new s(f):R===A.KHR_MATERIALS_CLEARCOAT?h[R]=new n:R===A.KHR_MATERIALS_UNLIT?h[R]=new r:R===A.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS?h[R]=new u:R===A.KHR_DRACO_MESH_COMPRESSION?h[R]=new l(f,this.dracoLoader):R===A.MSFT_TEXTURE_DDS?h[R]=new t(this.ddsLoader):R===A.KHR_TEXTURE_TRANSFORM?h[R]=new p:R===A.KHR_MESH_QUANTIZATION?h[R]=new d:0<=x.indexOf(R)&&console.warn("THREE.GLTFLoader: Unknown extension \""+R+"\".")}var y=new M(f,h,{path:a||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager});y.parse(c,m)}});var A={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};s.prototype.loadLight=function(e){var a,t=this.lightDefs[e],s=new Color(16777215);void 0!==t.color&&s.fromArray(t.color);var r=void 0===t.range?0:t.range;switch(t.type){case"directional":a=new DirectionalLight(s),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new PointLight(s),a.distance=r;break;case"spot":a=new SpotLight(s),a.distance=r,t.spot=t.spot||{},t.spot.innerConeAngle=void 0===t.spot.innerConeAngle?0:t.spot.innerConeAngle,t.spot.outerConeAngle=void 0===t.spot.outerConeAngle?Math.PI/4:t.spot.outerConeAngle,a.angle=t.spot.outerConeAngle,a.penumbra=1-t.spot.innerConeAngle/t.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type, \""+t.type+"\".");}return a.position.set(0,0,0),a.decay=2,void 0!==t.intensity&&(a.intensity=t.intensity),a.name=t.name||"light_"+e,Promise.resolve(a)},r.prototype.getMaterialType=function(){return MeshBasicMaterial},r.prototype.extendParams=function(e,a,t){var s=[];e.color=new Color(1,1,1),e.opacity=1;var r=a.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){var n=r.baseColorFactor;e.color.fromArray(n),e.opacity=n[3]}void 0!==r.baseColorTexture&&s.push(t.assignTexture(e,"map",r.baseColorTexture))}return Promise.all(s)},n.prototype.getMaterialType=function(){return MeshPhysicalMaterial},n.prototype.extendParams=function(e,a,t){var s=[],r=a.extensions[this.name];if(void 0!==r.clearcoatFactor&&(e.clearcoat=r.clearcoatFactor),void 0!==r.clearcoatTexture&&s.push(t.assignTexture(e,"clearcoatMap",r.clearcoatTexture)),void 0!==r.clearcoatRoughnessFactor&&(e.clearcoatRoughness=r.clearcoatRoughnessFactor),void 0!==r.clearcoatRoughnessTexture&&s.push(t.assignTexture(e,"clearcoatRoughnessMap",r.clearcoatRoughnessTexture)),void 0!==r.clearcoatNormalTexture&&(s.push(t.assignTexture(e,"clearcoatNormalMap",r.clearcoatNormalTexture)),void 0!==r.clearcoatNormalTexture.scale)){var n=r.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new Vector2(n,n)}return Promise.all(s)};var I="glTF",N={JSON:1313821514,BIN:5130562};l.prototype.decodePrimitive=function(e,a){var t=this.json,s=this.dracoLoader,r=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,o={},i={},l={};for(var p in n){var c=H[p]||p.toLowerCase();o[c]=n[p]}for(p in e.attributes){var c=H[p]||p.toLowerCase();if(void 0!==n[p]){var u=t.accessors[e.attributes[p]],d=O[u.componentType];l[c]=d,i[c]=!0===u.normalized}}return a.getDependency("bufferView",r).then(function(e){return new Promise(function(a){s.decodeDracoFile(e,function(e){for(var t in e.attributes){var s=e.attributes[t],r=i[t];void 0!==r&&(s.normalized=r)}a(e)},o,l)})})},p.prototype.extendTexture=function(e,a){return e=e.clone(),void 0!==a.offset&&e.offset.fromArray(a.offset),void 0!==a.rotation&&(e.rotation=a.rotation),void 0!==a.scale&&e.repeat.fromArray(a.scale),void 0!==a.texCoord&&console.warn("THREE.GLTFLoader: Custom UV sets in \""+this.name+"\" extension not yet supported."),e.needsUpdate=!0,e},c.prototype=Object.create(MeshStandardMaterial.prototype),c.prototype.constructor=c,c.prototype.copy=function(e){return MeshStandardMaterial.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},m.prototype=Object.create(Interpolant.prototype),m.prototype.constructor=m,m.prototype.copySampleValue_=function(e){for(var a=this.resultBuffer,t=this.sampleValues,s=this.valueSize,r=0;r!==s;r++)a[r]=t[3*(e*s)+s+r];return a},m.prototype.beforeStart_=m.prototype.copySampleValue_,m.prototype.afterEnd_=m.prototype.copySampleValue_,m.prototype.interpolate_=function(e,a,s,t){for(var r=this.resultBuffer,n=this.sampleValues,o=this.valueSize,l=3*o,c=t-a,u=(s-a)/c,p=u*u,d=p*u,m=e*l,g=m-l,h=-2*d+3*p,T=d-p,f=0;f!==o;f++){var S=n[g+f+o],R=n[g+f+2*o]*c,x=n[m+f+o],y=n[m+f]*c;r[f]=(1-h)*S+(T-p+u)*R+h*x+T*y}return r};var b={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},O={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},C={9728:NearestFilter,9729:LinearFilter,9984:NearestMipmapNearestFilter,9985:LinearMipmapNearestFilter,9986:NearestMipmapLinearFilter,9987:LinearMipmapLinearFilter},v={33071:ClampToEdgeWrapping,33648:MirroredRepeatWrapping,10497:RepeatWrapping},F={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},H={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},U={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},D={CUBICSPLINE:void 0,LINEAR:InterpolateLinear,STEP:InterpolateDiscrete},P={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"},G={"image/png":RGBAFormat,"image/jpeg":RGBFormat};return M.prototype.parse=function(e,a){var t=this,s=this.json,r=this.extensions;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then(function(a){var n={scene:a[0][s.scene||0],scenes:a[0],animations:a[1],cameras:a[2],asset:s.asset,parser:t,userData:{}};T(r,n,s),f(n,s),e(n)}).catch(a)},M.prototype.markDefs=function(){for(var e,a=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[],r={},n={},o=0,l=t.length;o<l;o++){e=t[o].joints;for(var p=0,c=e.length;p<c;p++)a[e[p]].isBone=!0}for(var u,d=0,m=a.length;d<m;d++)u=a[d],void 0!==u.mesh&&(void 0===r[u.mesh]&&(r[u.mesh]=n[u.mesh]=0),r[u.mesh]++,void 0!==u.skin&&(s[u.mesh].isSkinnedMesh=!0));this.json.meshReferences=r,this.json.meshUses=n},M.prototype.getDependency=function(e,a){var t=e+":"+a,s=this.cache.get(t);if(!s){switch(e){case"scene":s=this.loadScene(a);break;case"node":s=this.loadNode(a);break;case"mesh":s=this.loadMesh(a);break;case"accessor":s=this.loadAccessor(a);break;case"bufferView":s=this.loadBufferView(a);break;case"buffer":s=this.loadBuffer(a);break;case"material":s=this.loadMaterial(a);break;case"texture":s=this.loadTexture(a);break;case"skin":s=this.loadSkin(a);break;case"animation":s=this.loadAnimation(a);break;case"camera":s=this.loadCamera(a);break;case"light":s=this.extensions[A.KHR_LIGHTS_PUNCTUAL].loadLight(a);break;default:throw new Error("Unknown type: "+e);}this.cache.add(t,s)}return s},M.prototype.getDependencies=function(e){var a=this.cache.get(e);if(!a){var t=this,s=this.json[e+("mesh"===e?"es":"s")]||[];a=Promise.all(s.map(function(a,s){return t.getDependency(e,s)})),this.cache.add(e,a)}return a},M.prototype.loadBuffer=function(e){var a=this.json.buffers[e],t=this.fileLoader;if(a.type&&"arraybuffer"!==a.type)throw new Error("THREE.GLTFLoader: "+a.type+" buffer type is not supported.");if(void 0===a.uri&&0===e)return Promise.resolve(this.extensions[A.KHR_BINARY_GLTF].body);var s=this.options;return new Promise(function(e,r){t.load(g(a.uri,s.path),e,void 0,function(){r(new Error("THREE.GLTFLoader: Failed to load buffer \""+a.uri+"\"."))})})},M.prototype.loadBufferView=function(e){var a=this.json.bufferViews[e];return this.getDependency("buffer",a.buffer).then(function(e){var t=a.byteLength||0,s=a.byteOffset||0;return e.slice(s,s+t)})},M.prototype.loadAccessor=function(e){var a=this,t=this.json,s=this.json.accessors[e];if(void 0===s.bufferView&&void 0===s.sparse)return Promise.resolve(null);var r=[];return void 0===s.bufferView?r.push(null):r.push(this.getDependency("bufferView",s.bufferView)),void 0!==s.sparse&&(r.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(r).then(function(e){var r,n,o=e[0],l=F[s.type],p=O[s.componentType],c=p.BYTES_PER_ELEMENT,u=s.byteOffset||0,d=void 0===s.bufferView?void 0:t.bufferViews[s.bufferView].byteStride,m=!0===s.normalized;if(d&&d!==c*l){var g=Math.floor(u/d),h="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+g+":"+s.count,T=a.cache.get(h);T||(r=new p(o,g*d,s.count*d/c),T=new InterleavedBuffer(r,d/c),a.cache.add(h,T)),n=new InterleavedBufferAttribute(T,l,u%d/c,m)}else r=null===o?new p(s.count*l):new p(o,u,s.count*l),n=new BufferAttribute(r,l,m);if(void 0!==s.sparse){var f=F.SCALAR,S=O[s.sparse.indices.componentType],R=s.sparse.indices.byteOffset||0,x=s.sparse.values.byteOffset||0,y=new S(e[1],R,s.sparse.count*f),M=new p(e[2],x,s.sparse.count*l);null!==o&&(n=new BufferAttribute(n.array.slice(),n.itemSize,n.normalized));for(var _,E=0,L=y.length;E<L;E++)if(_=y[E],n.setX(_,M[E*l]),2<=l&&n.setY(_,M[E*l+1]),3<=l&&n.setZ(_,M[E*l+2]),4<=l&&n.setW(_,M[E*l+3]),5<=l)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}return n})},M.prototype.loadTexture=function(e){var a,t=this,s=this.json,r=this.options,n=this.textureLoader,o=self.URL||self.webkitURL,i=s.textures[e],l=i.extensions||{};a=l[A.MSFT_TEXTURE_DDS]?s.images[l[A.MSFT_TEXTURE_DDS].source]:s.images[i.source];var p=a.uri,c=!1;return void 0!==a.bufferView&&(p=t.getDependency("bufferView",a.bufferView).then(function(e){c=!0;var t=new Blob([e],{type:a.mimeType});return p=o.createObjectURL(t),p})),Promise.resolve(p).then(function(e){var a=r.manager.getHandler(e);return a||(a=l[A.MSFT_TEXTURE_DDS]?t.extensions[A.MSFT_TEXTURE_DDS].ddsLoader:n),new Promise(function(t,s){a.load(g(e,r.path),t,void 0,s)})}).then(function(e){!0===c&&o.revokeObjectURL(p),e.flipY=!1,i.name&&(e.name=i.name),a.mimeType in G&&(e.format=G[a.mimeType]);var t=s.samplers||{},r=t[i.sampler]||{};return e.magFilter=C[r.magFilter]||LinearFilter,e.minFilter=C[r.minFilter]||LinearMipmapLinearFilter,e.wrapS=v[r.wrapS]||RepeatWrapping,e.wrapT=v[r.wrapT]||RepeatWrapping,e})},M.prototype.assignTexture=function(e,a,t){var s=this;return this.getDependency("texture",t.index).then(function(r){if(r.isCompressedTexture||("aoMap"===a||"emissiveMap"===a||"metalnessMap"===a||"normalMap"===a||"roughnessMap"===a?r.format=RGBFormat:void 0),void 0===t.texCoord||0==t.texCoord||"aoMap"===a&&1==t.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+t.texCoord+" for texture "+a+" not yet supported."),s.extensions[A.KHR_TEXTURE_TRANSFORM]){var n=void 0===t.extensions?void 0:t.extensions[A.KHR_TEXTURE_TRANSFORM];n&&(r=s.extensions[A.KHR_TEXTURE_TRANSFORM].extendTexture(r,n))}e[a]=r})},M.prototype.assignFinalMaterial=function(e){var a=e.geometry,t=e.material,s=void 0!==a.attributes.tangent,r=void 0!==a.attributes.color,n=void 0===a.attributes.normal,o=!0===e.isSkinnedMesh,i=0<Object.keys(a.morphAttributes).length,l=i&&void 0!==a.morphAttributes.normal;if(e.isPoints){var p="PointsMaterial:"+t.uuid,c=this.cache.get(p);c||(c=new PointsMaterial,Material.prototype.copy.call(c,t),c.color.copy(t.color),c.map=t.map,c.sizeAttenuation=!1,this.cache.add(p,c)),t=c}else if(e.isLine){var p="LineBasicMaterial:"+t.uuid,u=this.cache.get(p);u||(u=new LineBasicMaterial,Material.prototype.copy.call(u,t),u.color.copy(t.color),this.cache.add(p,u)),t=u}if(s||r||n||o||i){var p="ClonedMaterial:"+t.uuid+":";t.isGLTFSpecularGlossinessMaterial&&(p+="specular-glossiness:"),o&&(p+="skinning:"),s&&(p+="vertex-tangents:"),r&&(p+="vertex-colors:"),n&&(p+="flat-shading:"),i&&(p+="morph-targets:"),l&&(p+="morph-normals:");var d=this.cache.get(p);d||(d=t.clone(),o&&(d.skinning=!0),s&&(d.vertexTangents=!0),r&&(d.vertexColors=!0),n&&(d.flatShading=!0),i&&(d.morphTargets=!0),l&&(d.morphNormals=!0),this.cache.add(p,d)),t=d}t.aoMap&&void 0===a.attributes.uv2&&void 0!==a.attributes.uv&&a.setAttribute("uv2",a.attributes.uv),t.normalScale&&!s&&(t.normalScale.y=-t.normalScale.y),t.clearcoatNormalScale&&!s&&(t.clearcoatNormalScale.y=-t.clearcoatNormalScale.y),e.material=t},M.prototype.loadMaterial=function(e){var a,t=this,s=this.json,r=this.extensions,n=s.materials[e],o={},i=n.extensions||{},l=[];if(i[A.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var p=r[A.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];a=p.getMaterialType(),l.push(p.extendParams(o,n,t))}else if(i[A.KHR_MATERIALS_UNLIT]){var u=r[A.KHR_MATERIALS_UNLIT];a=u.getMaterialType(),l.push(u.extendParams(o,n,t))}else{a=MeshStandardMaterial;var d=n.pbrMetallicRoughness||{};if(o.color=new Color(1,1,1),o.opacity=1,Array.isArray(d.baseColorFactor)){var m=d.baseColorFactor;o.color.fromArray(m),o.opacity=m[3]}void 0!==d.baseColorTexture&&l.push(t.assignTexture(o,"map",d.baseColorTexture)),o.metalness=void 0===d.metallicFactor?1:d.metallicFactor,o.roughness=void 0===d.roughnessFactor?1:d.roughnessFactor,void 0!==d.metallicRoughnessTexture&&(l.push(t.assignTexture(o,"metalnessMap",d.metallicRoughnessTexture)),l.push(t.assignTexture(o,"roughnessMap",d.metallicRoughnessTexture)))}!0===n.doubleSided&&(o.side=DoubleSide);var g=n.alphaMode||P.OPAQUE;if(g===P.BLEND?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,g===P.MASK&&(o.alphaTest=void 0===n.alphaCutoff?.5:n.alphaCutoff)),void 0!==n.normalTexture&&a!==MeshBasicMaterial&&(l.push(t.assignTexture(o,"normalMap",n.normalTexture)),o.normalScale=new Vector2(1,1),void 0!==n.normalTexture.scale&&o.normalScale.set(n.normalTexture.scale,n.normalTexture.scale)),void 0!==n.occlusionTexture&&a!==MeshBasicMaterial&&(l.push(t.assignTexture(o,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(o.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&a!==MeshBasicMaterial&&(o.emissive=new Color().fromArray(n.emissiveFactor)),void 0!==n.emissiveTexture&&a!==MeshBasicMaterial&&l.push(t.assignTexture(o,"emissiveMap",n.emissiveTexture)),i[A.KHR_MATERIALS_CLEARCOAT]){var h=r[A.KHR_MATERIALS_CLEARCOAT];a=h.getMaterialType(),l.push(h.extendParams(o,{extensions:i},t))}return Promise.all(l).then(function(){var e;return e=a===c?r[A.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(o):new a(o),n.name&&(e.name=n.name),e.map&&(e.map.encoding=sRGBEncoding),e.emissiveMap&&(e.emissiveMap.encoding=sRGBEncoding),f(e,n),n.extensions&&T(r,e,n),e})},M.prototype.loadGeometries=function(e){function a(e){return s[A.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then(function(a){return E(a,e,t)})}for(var t=this,s=this.extensions,r=this.primitiveCache,n=[],o=0,l=e.length;o<l;o++){var p=e[o],c=x(p),u=r[c];if(u)n.push(u.promise);else{var d;d=p.extensions&&p.extensions[A.KHR_DRACO_MESH_COMPRESSION]?a(p):E(new BufferGeometry,p,t),r[c]={primitive:p,promise:d},n.push(d)}}return Promise.all(n)},M.prototype.loadMesh=function(e){for(var a,t=this,s=this.json,r=s.meshes[e],n=r.primitives,o=[],l=0,p=n.length;l<p;l++)a=void 0===n[l].material?h(this.cache):this.getDependency("material",n[l].material),o.push(a);return o.push(t.loadGeometries(n)),Promise.all(o).then(function(a){for(var s=a.slice(0,a.length-1),o=a[a.length-1],l=[],p=0,c=o.length;p<c;p++){var u,d=o[p],m=n[p],g=s[p];if(m.mode===b.TRIANGLES||m.mode===b.TRIANGLE_STRIP||m.mode===b.TRIANGLE_FAN||void 0===m.mode)u=!0===r.isSkinnedMesh?new SkinnedMesh(d,g):new Mesh(d,g),!0!==u.isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),m.mode===b.TRIANGLE_STRIP?u.geometry=L(u.geometry,TriangleStripDrawMode):m.mode===b.TRIANGLE_FAN&&(u.geometry=L(u.geometry,TriangleFanDrawMode));else if(m.mode===b.LINES)u=new LineSegments(d,g);else if(m.mode===b.LINE_STRIP)u=new Line(d,g);else if(m.mode===b.LINE_LOOP)u=new LineLoop(d,g);else if(m.mode===b.POINTS)u=new Points(d,g);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);0<Object.keys(u.geometry.morphAttributes).length&&R(u,r),u.name=r.name||"mesh_"+e,1<o.length&&(u.name+="_"+p),f(u,r),t.assignFinalMaterial(u),l.push(u)}if(1===l.length)return l[0];for(var h=new Group,p=0,c=l.length;p<c;p++)h.add(l[p]);return h})},M.prototype.loadCamera=function(e){var a,t=this.json.cameras[e],s=t[t.type];return s?("perspective"===t.type?a=new PerspectiveCamera(MathUtils.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):"orthographic"===t.type&&(a=new OrthographicCamera(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),t.name&&(a.name=t.name),f(a,t),Promise.resolve(a)):void console.warn("THREE.GLTFLoader: Missing camera parameters.")},M.prototype.loadSkin=function(e){var a=this.json.skins[e],t={joints:a.joints};return void 0===a.inverseBindMatrices?Promise.resolve(t):this.getDependency("accessor",a.inverseBindMatrices).then(function(e){return t.inverseBindMatrices=e,t})},M.prototype.loadAnimation=function(e){for(var a=this.json,t=a.animations[e],s=[],r=[],n=[],o=[],l=[],p=0,c=t.channels.length;p<c;p++){var u=t.channels[p],d=t.samplers[u.sampler],g=u.target,h=void 0===g.node?g.id:g.node,T=void 0===t.parameters?d.input:t.parameters[d.input],f=void 0===t.parameters?d.output:t.parameters[d.output];s.push(this.getDependency("node",h)),r.push(this.getDependency("accessor",T)),n.push(this.getDependency("accessor",f)),o.push(d),l.push(g)}return Promise.all([Promise.all(s),Promise.all(r),Promise.all(n),Promise.all(o),Promise.all(l)]).then(function(a){for(var s=a[0],r=a[1],n=a[2],o=a[3],l=a[4],p=[],c=0,u=s.length;c<u;c++){var d=s[c],g=r[c],h=n[c],T=o[c],f=l[c];if(void 0!==d){d.updateMatrix(),d.matrixAutoUpdate=!0;var S;switch(U[f.path]){case U.weights:S=NumberKeyframeTrack;break;case U.rotation:S=QuaternionKeyframeTrack;break;case U.position:case U.scale:default:S=VectorKeyframeTrack;}var R=d.name?d.name:d.uuid,x=void 0===T.interpolation?InterpolateLinear:D[T.interpolation],y=[];U[f.path]===U.weights?d.traverse(function(e){!0===e.isMesh&&e.morphTargetInfluences&&y.push(e.name?e.name:e.uuid)}):y.push(R);var M=h.array;if(h.normalized){var _;if(M.constructor===Int8Array)_=1/127;else if(M.constructor===Uint8Array)_=1/255;else if(M.constructor==Int16Array)_=1/32767;else if(M.constructor===Uint16Array)_=1/65535;else throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");for(var E=new Float32Array(M.length),L=0,A=M.length;L<A;L++)E[L]=M[L]*_;M=E}for(var I,L=0,A=y.length;L<A;L++)I=new S(y[L]+"."+U[f.path],g.array,M,x),"CUBICSPLINE"===T.interpolation&&(I.createInterpolant=function(e){return new m(this.times,this.values,this.getValueSize()/3,e)},I.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),p.push(I)}}var N=t.name?t.name:"animation_"+e;return new AnimationClip(N,void 0,p)})},M.prototype.loadNode=function(e){var a=this.json,t=this.extensions,s=this,r=a.meshReferences,n=a.meshUses,l=a.nodes[e];return function(){var e=[];return void 0!==l.mesh&&e.push(s.getDependency("mesh",l.mesh).then(function(e){var a;if(1<r[l.mesh]){var t=n[l.mesh]++;a=e.clone(),a.name+="_instance_"+t}else a=e;return void 0!==l.weights&&a.traverse(function(e){if(e.isMesh)for(var a=0,t=l.weights.length;a<t;a++)e.morphTargetInfluences[a]=l.weights[a]}),a})),void 0!==l.camera&&e.push(s.getDependency("camera",l.camera)),l.extensions&&l.extensions[A.KHR_LIGHTS_PUNCTUAL]&&void 0!==l.extensions[A.KHR_LIGHTS_PUNCTUAL].light&&e.push(s.getDependency("light",l.extensions[A.KHR_LIGHTS_PUNCTUAL].light)),Promise.all(e)}().then(function(e){var a;if(a=!0===l.isBone?new Bone:1<e.length?new Group:1===e.length?e[0]:new Object3D,a!==e[0])for(var s=0,r=e.length;s<r;s++)a.add(e[s]);if(l.name&&(a.userData.name=l.name,a.name=PropertyBinding.sanitizeNodeName(l.name)),f(a,l),l.extensions&&T(t,a,l),void 0!==l.matrix){var n=new Matrix4;n.fromArray(l.matrix),a.applyMatrix4(n)}else void 0!==l.translation&&a.position.fromArray(l.translation),void 0!==l.rotation&&a.quaternion.fromArray(l.rotation),void 0!==l.scale&&a.scale.fromArray(l.scale);return a})},M.prototype.loadScene=function(){function e(a,t,s,r){var n=s.nodes[a];return r.getDependency("node",a).then(function(e){if(void 0===n.skin)return e;var a;return r.getDependency("skin",n.skin).then(function(e){a=e;for(var t=[],s=0,n=a.joints.length;s<n;s++)t.push(r.getDependency("node",a.joints[s]));return Promise.all(t)}).then(function(t){return e.traverse(function(e){if(e.isMesh){for(var s,r=[],n=[],o=0,i=t.length;void 0>o;o++)if(s=t[o],s){r.push(s);var l=new Matrix4;void 0!==a.inverseBindMatrices&&l.fromArray(a.inverseBindMatrices.array,16*o),n.push(l)}else console.warn("THREE.GLTFLoader: Joint \"%s\" could not be found.",a.joints[o]);e.bind(new Skeleton(r,n),e.matrixWorld)}}),e})}).then(function(a){t.add(a);var o=[];if(n.children)for(var l,p=n.children,c=0,u=p.length;c<u;c++)l=p[c],o.push(e(l,a,s,r));return Promise.all(o)})}return function(a){var t=this.json,s=this.extensions,r=this.json.scenes[a],n=this,o=new Group;r.name&&(o.name=r.name),f(o,r),r.extensions&&T(s,o,r);for(var l=r.nodes||[],p=[],c=0,u=l.length;c<u;c++)p.push(e(l[c],o,t,n));return Promise.all(p).then(function(){return o})}}(),e}();export{GLTFLoader};
